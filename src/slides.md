---
title: Blazor Best Practices
theme: night
revealOptions:
  transition: "slide"
---

## Blazor best practices borrowed from ReactJS

http://pugh.pw/blazor-talk

Note: Hi everyone, and thanks for coming to hear me talk about "Blazor best practices borrowed from ReactJS".
what that essentially means is that we're going to go over a handful of practices and lessons learned that I've picked up over the years of creating rich stateful UIs with component based javascript frameworks.
and hopefully spare you some of the battle scars that I have.
---

### About me

* I'm Brandon Pugh
* I've been webdeving for 12+ years, a software consultant for 8 years, at Headspring and now Accenture
* Interests include UI/UX, automated testing, git, dev tooling/productivity
* [@brndnpugh](https://twitter.com/brndnpugh)
* https://brandonpugh.com/

---

### Who is this talk for?

* Some blazor experience
* No react experience required
* Blazor devs
* UI devs
* devs

Note: A lot of the points I'm going to cover in this talk could probably each deserve an entire talk on their own. But I want to give you at least an overview and make you aware of these concepts so you can hopefully dive into them deeper on your own.
---

## State

* Managing state is hard
* Shared mutable state the root of all evil?

Notes: Let's talk about state. Managing state is hard. In functional programming circles you're likely to hear a popular expression that "shared mutable state is the root of all evil". and I don't think they're far off. There's a reason that it's 2022 and the most common piece of troubleshooting advice you're likely to hear is "have you tried turning it off and on again?".

* With rich UIs we have to deal with a lot of state so I want start of with some ways to help you manage it better.

---

### Don't sync state, derive it

---

``` html
<SubmitButton Text="@SubmitButtonText" OnClick="Submit" />
```

Notes: Let's start with a simple example.
---

``` csharp [1-2|9-10]
private string SubmitButtonText = "Create";
private bool IsEdit = false;

...

private void OnModelLoaded(){
  ...

  IsEdit = true;
  SubmitButtonText = "Update";
}
```

---
``` html
<SubmitButton Text="@(IsEdit ? "Update" : "Create")" OnClick="Submit" />
```
---

``` html
<SubmitButton Text="Save" Disabled="@IsSubmitAllowed" OnClick="Submit" />
```
---

``` csharp [10|49|77|99|154|187]
// code is for illustrative purposes only
// and may or may not have been generated by an AI
[Parameter]
public CustomerModel LoadedModel { get; set; } = new();

private AddCustomerModel Model { get; set; } = new();

private string? _parentPath;
private string newAccountNumberLabel = "";
private bool IsSubmitAllowed = true;
private bool IsStartedDateChecked = false;
private bool IsCompletedDateChecked = false;
private bool _isSetAccount;
private CustomerModel? _CustomerModel;

protected override void OnInitialized()
{
    var currentPath = NavManager.ToBaseRelativePath(NavManager.Uri);
    _parentPath = currentPath.GetParentPath();
}

protected override async Task OnParametersSetAsync()
{
    _isSetAccount = !string.IsNullOrEmpty(LoadedModel.Model.AccountNumber);
    if(_isSetAccount)
    {
        await OnAccountFetched(new AccountFetchedEvent { Response = LoadedModel });
        if (!string.IsNullOrEmpty(LoadedModel.Model.NewAccountNumber))
        {
            await GetAccountToTransferTo(LoadedModel.Model.NewAccountNumber);
        }
    }

}

private void InitializeNewCustomer(string accountNumber)
{
    Model.AccountNumber = accountNumber;
    Model.CustomerType = CustomerTypes.Installation.Value;
    Model.ToppingType = ToppingTypes.First();
    Model.Start = new Date();
    Model.Like = LikeType.Inside;
    //TODO: fix this!
    Model.Favorites = "All";
    Model.StartMonth = DateTime.Now.AddMonths(1).ToString("MM");
    Model.IsAdmin = string.IsNullOrEmpty(Model.IsAdmin) ? "1" : Model.IsAdmin;
    IsCompletedDateChecked = false;
    IsPromisedDateChecked = false;
    IsSubmitAllowed = false;
    Model.UserType = UserTypes.GetDefaultUserType(Model.ToppingType);
    Model.UserCode = UserCodeType.GetDefaultUserCode(Model.ToppingType);
}

private async Task GetAccountToTransferTo(string newAccountNumber)
{
    if (string.IsNullOrEmpty(newAccountNumber))
        return;

    Model.AccountToTransferTo = await Api.QueryAsync("api/Customer/GetCustomerByAccountNumber", new GetCustomerByAccountNumberQuery() { AccountNumber = newAccountNumber });

    if (Model.CustomerType == CustomerTypes.AccountNumberChange
    && !string.IsNullOrEmpty(Model.AccountToTransferTo.AccountNumber))
    {
        var notification = new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Account Number already in use",
                    Detail = "Please use a different Account Number.",
                    Duration = 10000
                };
        NotificationTopping.Notify(notification);
    }
}

private bool DisplayAccountDetails()
{
    IsSubmitAllowed = true;
    return Model.CustomerType == CustomerTypes.Regular;
}

private async Task OnAccountFetched(AccountFetchedEvent fetchedEvent)
{
    _CustomerModel = fetchedEvent.Response;

    if (_CustomerModel.IsAccountNumberUnused)
    {
        Model = new AddCustomerModel();
        InitializeNewCustomer(fetchedEvent.AccountNumberEntered);
    }
    else
    {
        if (_CustomerModel.IsOpen)
        {
            await OpenEditMessage();
        }
        else
        {
            _CustomerModel.Model.CustomerId = 0;
            IsSubmitAllowed = false;
            LoadExistingCustomer();
        }
    }
}

private async Task OpenEditMessage()
{
    await DialogTopping.OpenAsync("Existing Open Topping Order", ds =>
@<ConfirmationDialog OnClickConfirm="EditCustomer" OnClickCancel="ClearAccountNumber"
                      TItem="string" ConfirmBtnText="Edit">
    <div style="text-align:center">
        <p>
            This account has an existing open Topping order: <strong>@CustomerTypes.FromValue(_CustomerModel!.Model.CustomerType).Name - @_CustomerModel.Model.AccountNumber</strong>
            <br>
            Please edit or delete this Topping order before opening a new one.
        </p>
    </div>
</ConfirmationDialog>
);
}

private void ClearAccountNumber()
{
    InitializeNewCustomer("");
}

private void EditCustomer()
{
    LoadExistingCustomer();
    DialogTopping.Close();
}

private bool IsEdit()
{
    return Model.CustomerId > 0;
}

private bool ShowNewAccountNumber()
{
    switch (Model.CustomerType)
    {
        case nameof(CustomerTypes.Transfer):
            newAccountNumberLabel = "Transfer to this Account Number:";
            return true;
        case nameof(CustomerTypes.AccountNumberChange):
            newAccountNumberLabel = "New Account Number:";
            return true;
    }
    return false;
}

private void LoadExistingCustomer()
{
    Model = _CustomerModel!.Model;
    IsSubmitAllowed = true;
    IsPromisedDateChecked = Model.PromisedDate.HasValue;
    IsCompletedDateChecked = Model.CompletedDate.HasValue;
}

private string StatusMessage()
{
    return Model.IsAccountDisconnected() ? CustomerStatus.FromValue(Model.AccountStatus!).Name : "";
}

private void OnPromisedDateCheckedChange(bool args)
{
    Model.PromisedDate = args ? DateTime.Now : null;
}

private void OnCompletedDateCheckedChange(bool args)
{
    Model.CompletedDate = args ? DateTime.Now : null;
}

private void ReturnToParentPage()
{
    var notification = new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Topping order saved successfully",
            Duration = 10000
        };
    NotificationTopping.Notify(notification);
    if (!String.IsNullOrEmpty(_parentPath))
    {
        NavManager.NavigateTo(_parentPath.ToString());
    }
    IsSubmitAllowed = false;
}

private void HandleSubmitClick()
{
    JsRuntime.InvokeVoidAsync("ScrollToTop");
}
```
---
``` html
<SubmitButton Text="Save" Disabled="@Order.CanUpdate()" OnClick="Submit" />
```
---

``` cshtml
<p>Full name: @($"{FistName} {LastName}")</p>

<p>Shopping cart total: @(ShoppingCartItems.Sum(x => x.Amount))</p>
```
---

* If you're about to create a new piece of state, make that sure you can't calculate it from an existing piece of state first
* Fewer bugs, easier to read <!-- .element: class="fragment" -->
* Won't this make my UI slow? <!-- .element: class="fragment" -->
* &shy;<!-- .element: class="fragment" -->Reach for [memoization](https://en.wikipedia.org/wiki/Memoization) first

---

### Where should I put my state?

* Colocation, colocation, colocation
  * "Place code as close to where it's relevant as possible"
* [Lift state (react docs)](https://reactjs.org/docs/lifting-state-up.html) when necessary
  * "lift the shared state up to their closest common ancestor"

---
<!-- .slide: data-background-image="where-to-put-state.jpg" -->
<!-- .slide: data-background-size="contain" -->
[State Colocation will make your React app faster](https://kentcdodds.com/blog/state-colocation-will-make-your-react-app-faster)<!-- .element: class="fragment" -->
---

### Make impossible states impossible

---

``` cshtml [3-6|7-10|11-21|28-42|39]
<h1>Weather forecast</h1>

@if (_isLoading)
{
    <p><em>Loading...</em></p>
}
@if (_errorMessage != null)
{
    <p>@_errorMessage</p>
}
@if (forecasts != null)
{
    <ul>
        @foreach (var forecast in forecasts)
        {
            <li>
                <p>@forecast.Date.ToShortDateString(): @forecast.Summary</p>
            </li>
        }
    </ul>
}

@code {
    private WeatherForecast[]? forecasts;
    private string? _errorMessage;
    private bool _isLoading;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;
            forecasts = await Http.GetFromJsonAsync<WeatherForecast[]>("WeatherForecast");
            _isLoading = false;
        }
        catch (Exception exception)
        {
            _errorMessage = exception.Message;
            _isLoading = false;
        }
    }
}
```

---
``` csharp [13|8-11|1|15-25]
<button onclick="@LoadData">Refresh</button>

@code {
    private WeatherForecast[]? forecasts;
    private string? _errorMessage;
    private bool _isLoading;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            _isLoading = true;
            forecasts = await Http.GetFromJsonAsync<WeatherForecast[]>("WeatherForecast");
            _isLoading = false;
        }
        catch (Exception exception)
        {
            _errorMessage = exception.Message;
            _isLoading = false;
        }
    }
}
```
---

``` cshtml [1-6|10|21,23,28|33-51]
    public enum Status
    {
        Loading,
        Loaded,
        Error
    }

    private WeatherForecast[]? forecasts;
    private string? _errorMessage;
    private Status _status;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            _status = Status.Loading;
            forecasts = await Http.GetFromJsonAsync<WeatherForecast[]>("WeatherForecast");
            _status = Status.Loaded;
        }
        catch (Exception exception)
        {
            _errorMessage = exception.Message;
            _status = Status.Error;
        }

    }

@switch (_status)
{
    case Status.Loading:
        <p><em>Loading...</em></p>
        break;
    case Status.Error:
        <p>@_errorMessage</p>
        break;
    case Status.Loaded:
        <ul>
            @foreach (var forecast in forecasts)
            {
                <li>
                    <p>@forecast.Date.ToShortDateString(): @forecast.Summary</p>
                </li>
            }
        </ul>
        break;
}
```
---

* Make impossible states impossible
* &shy;<!-- .element: class="fragment" -->Stop using `isloading` booleans
* For more complex scenarios consider using state machines <!-- .element: class="fragment" -->
  * [Xstate](https://xstate.js.org/) for JS
  * [Stateless](https://github.com/dotnet-state-machine/stateless) for .NET
  * [David Khourshid - Infinitely Better UIs with Finite Automata - YouTube](https://www.youtube.com/watch?v=VU1NKX6Qkxc)

---

## Reusable components

---

### When should create a new component?

* What is the abstraction?
* DRY vs WET

Note: A component is just like any other abstraction which is what makes all these newer UI frameworks so powerful because it let's us compose our UIs just we do with classes and functions.
But just like with those constructs, we have to be careful about the types of abstraction we create.
The most well known of the SOLID design principles is the 'D' which stands for "don't repeat yourself" or DRY for short.
---

> Duplication is far cheaper than the wrong abstraction
#### - Sandi Metz

---

### How do we know if we should be wet or dry?

---

### Too wet?

Pain point:

* You have to keep making the same change in multiple places <!-- .element: class="fragment" -->

The bug:

* You forgot to make the change in one of those places <!-- .element: class="fragment" -->

---

### Too dry?

Pain point:

  * You have keep adding conditionals or handling special cases <!-- .element: class="fragment" -->

The bug:

  * You unexpectedly break a different part of the app <!-- .element: class="fragment" -->

---

### Abstract out accessibility

Note: I've been toying with the idea of doing a talk about how to bake accessibility into apps from the beginning
 For a large part of my career I didn't have to care about accessibility in the apps I built because we would ask our clients or stakeholders "what accessibility concerns" do you have but I've come to realize that we shouldn't be asking this question
---

``` html
<div class="form-field">
    <label>Name:</label>
    <div>
        <InputText @bind-Value="Address.Name" />
        <ValidationMessage For="@(() => Address.Name)" />
    </div>
</div>
```
---
``` html [1-12|2,5-6,9]
<div class="form-field">
    <label for"AddressName">Name:</label>
    <div>
        <InputText
          id="AddressName"
          aria-describedby="AddressNameValidation"
          @bind-Value="Address.Name" />
        <ValidationMessage
          id="AddressNameValidation"
          For="@(() => Address.Name)" />
    </div>
</div>
```
---
``` html
@using Microsoft.AspNetCore.Components
@inherits InputText

<div class="@InputClass">
    <label for="@_generatedId">@LabelText</label>
    <InputText
        @bind-Value="CurrentValue"
        id="@_generatedId"
        aria-describedby="@_validationId"
        @attributes="AdditionalAttributes"/>
    <ValidationMessage id="@_validationId" For="ValueExpression"/>
</div>
```
---
``` html
<MyAppTextField
  LabelText="Name"
  @bind-value="@Address.Name" />
```
---

### Wrap Third-party libraries

``` html
// MyAppTextField.razor
<MudTextField
    @bind-Value="CurrentValue"
    Label="@LabelText"
    Variant="Variant.Text"
    For="ValueExpression"
/>
```

* Less tightly coupled to this dependency <!-- .element: class="fragment" -->
* Enforce consistent use of third-party components<!-- .element: class="fragment" -->
* Visual and UX consistency<!-- .element: class="fragment" -->
* Easier code review<!-- .element: class="fragment" -->

---

``` html
<MyAppTextField
  LabelText="Name"
  @bind-value="@Address.Name" />
```
---

### Leverage Render Fragments

---

``` html
<div class="chat">
    @foreach (var message in messages)
    {
        @ChatMessageDisplay(message)
    }
</div>

@code {
    private RenderFragment<ChatMessage> ChatMessageDisplay = message =>
        @<div class="chat-message">
            <span class="author">@message.Author</span>
            <span class="text">@message.Text</span>
        </div>;
}
```

---

``` cshtml
// Utils.razor
@code {

  public static RenderFragment<bool> RenderBoolean = (value) =>
  {
      return value ? RenderIcon(("arrow-right", "yes")) : @<span></span>;
  };

  public static RenderFragment<(string iconType, string label)> RenderIcon =
    (value) =>
      @<span
        class="@($"oi oi-{value.iconType}")"
        aria-hidden="true"
        aria-label="@value.label">
      </span>;

}
```

``` html
<GridColumn>
    @Utils.RenderBoolean(item.IsActive)
</GridColumn>

```

---

## Testing

Note: Testing is another topic that can be an entire workshop all by itself and very likely might be the topic of my next talk.
So I'm not going to go into too much detail of the specifics but instead touch on some guiding principles that have served me well in react and Angular projects and that I've started to incorporate into Blazor.
That also means you could apply these techniques to those other frameworks if you haven't tried it already.
---

> Write tests. Not too many. Mostly integration.
#### - Guillermo Rauch

---

### [Testing Library](https://testing-library.com/)

> The more your tests resemble the way your software is used, the more confidence they can give you.

---

<!-- .slide: data-background-image="testing-libs.png" -->
<!-- .slide: data-background-size="contain" -->

---


* Test from the user's perspective
* Avoid testing implementation details i.e. markup
* Avoid mocking as much as possible

Note: The more your tests resemble the way your software is used, the more confidence they can give you. This focusing on system behaviors and avoiding implementation details.

---

``` csharp
// ❌
var input = cut.Find('.heading')
cut.MarkupMatches(@<h1>Hello world from Blazor</h1>);

// ✅
var heading = cut.GetByText("hello world");
heading.ShouldNotBeNull();
```

---
``` csharp
public static class BunitExtensions
{
  public static IElement GetByLabelText(
    this IRenderedFragment cut, string labelText)
  {
      var labels = cut.FindAll("label");

      var inputLabel = labels.FirstOrDefault(label =>
          label.InnerHtml.Contains(labelText));

      if (inputLabel is null)
      {
          Console.WriteLine(cut.Markup);
          throw new ElementNotFoundException(labelText);
      }

      var inputId = inputLabel.Attributes.GetNamedItem("for").Value;
      var input = cut.Find($"#{inputId}");
      return input;
  }
}
```

---


``` csharp [5-17|5-7|9-14|1-3|17]
mockedHttpClient.Expect("*api/accounts")
    .WithQueryString(nameof(AccountRequestModel.AccountNumber), testAccountNumber)
    .RespondJson(new UpdateResponseModel() { AccountNumber = testAccountNumber, CustomerName = "Marty" });

// Arrange
using var ctx = new TestContext();
var cut = ctx.RenderComponent<AccountForm>();

// Act
var input = cut.GetByLabelText("customer name");
input.Change("Marty");

var submitButton = cut.GetButtonByName("save");
submitButton.Click();

// Assert
mockedHttpClient.VerifyNoOutstandingExpectation();

```
---

``` html
// AccountForm.razor
<EditForm>
  <MyAppTextField
    @bind-Value="Model.CustomerName"
    LabelName="Customer Name">
  <SubmitButton Text="Save">
</EditForm>
```
---

``` html
@using Microsoft.AspNetCore.Components
@inherits InputText

<div class="@InputClass">
    <label for="@_generatedId">@LabelText</label>
    <InputText
        @bind-Value="CurrentValue"
        id="@_generatedId"
        aria-describedby="@_validationId"
        @attributes="AdditionalAttributes"/>
    <ValidationMessage id="@_validationId" For="ValueExpression"/>
</div>
```

``` html
// MyAppTextField.razor
<MudTextField
    @bind-Value="CurrentValue"
    Label="@LabelText"
    Variant="Variant.Text"
    For="ValueExpression"
/>
```

---

## Testing resources

* [Bunit](https://bunit.dev/docs/getting-started/index.html)
* [Testing Library](https://testing-library.com/)
* https://testing-playground.com/
* https://playwright.dev/dotnet/docs/intro
* [Test Driven Development with react-testing-library | Youtube](https://www.youtube.com/watch?v=kCR3JAR7CHE)

---

### Feedback is a gift

* What did you like?
* What could have been better?
* [@brndnpugh](https://twitter.com/brndnpugh)
* https://brandonpugh.com/
---

### Resources

* [99 Bottles — Sandi Metz](https://sandimetz.com/99bottles)
* https://testing-library.com/docs/queries/about#priority (DOM query priority)
* [Don't Sync State. Derive It](https://kentcdodds.com/blog/dont-sync-state-derive-it)
* [Stop using isLoading booleans](https://kentcdodds.com/blog/stop-using-isloading-booleans)
* [How to Have an Amicable Breakup With A JavaScript Library | Youtube](https://www.youtube.com/watch?v=ZIIeBOLOgTw)


<style>
.reveal pre code {
  max-height: 600px;
}
.reveal pre.code-wrapper {
  width: unset;
}

  /* accenture theme */
.controls-arrow {
  color: white;
}
body {
  --r-background-color: #460073;
}
.reveal li > code {
  font-family: Monaco,Menlo,Consolas,Courier New,monospace!important;
  color: #e8912d; /* maybe #569cd6 to match VS blue */
  padding: 2px 3px 1px;
  border: 1px solid rgb(34, 63, 80);
  border-radius: 3px;
  --sk_foreground_min: 232,232,232;
  background-color: rgba(var(--sk_foreground_min,29,28,29),.04);
}
</style>
